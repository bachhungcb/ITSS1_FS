version: '3.8'

services:
  # --- Gateway Service (Mới) ---
  gateway:
    image: nginx:1.25-alpine
    container_name: itss_gateway
    ports:
      - "3636:443" # Port HTTPS chuẩn
      - "3618:80"   # Port HTTP (để redirect)
    volumes:
      - ./nginx-gateway.conf:/etc/nginx/conf.d/default.conf
      - ./certs:/etc/nginx/certs
    networks:
      - app-network
    depends_on:
      - frontend
      - backend

  # --- Backend Service ---
  backend:
    build:
      context: ./ITSS_BE
      dockerfile: Api/Dockerfile
    container_name: itss_backend
    # BỎ mapping ports cũ đi để bảo mật
    expose:
      - "80" # Chỉ mở port 80 cho các container khác trong mạng nội bộ
    networks:
      - app-network
    environment:
      - ASPNETCORE_HTTP_PORTS=80
    restart: always

  # --- Frontend Service ---
  frontend:
    build:
      context: ./ITSS_FE
      dockerfile: Dockerfile
    container_name: itss_frontend
    # BỎ mapping ports cũ (3636:80)
    expose:
      - "80"
    networks:
      - app-network
    depends_on:
      - backend
    restart: always

networks:
  app-network:
    driver: bridge